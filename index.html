<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* New Dark Theme Colors */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Deep Charcoal Gray */
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
        /* Custom scrollbar for project list to match dark theme */
        .project-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .project-list-container::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        .project-list-container::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        /* Custom styling for the progress slider */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #4a5568;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }
        /* Style for disabled slider */
        input[type="range"]:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #8b5cf6; /* Purple accent color */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        /* Hide thumb for disabled slider */
        input[type="range"]:disabled::-webkit-slider-thumb {
            visibility: hidden;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <!-- Changed max-w-4xl to w-[90%] to make the container occupy 90% of the screen width -->
    <div id="app-container" class="bg-gray-800 rounded-2xl shadow-2xl w-[90%] max-w-none overflow-hidden min-h-[700px] flex flex-col">

        <!-- Login Page -->
        <section id="login-page" class="p-8 md:p-12 flex-grow flex items-center justify-center transition-opacity duration-500">
            <div class="w-full max-w-md">
                <h1 id="login-heading" class="text-3xl md:text-4xl font-bold text-center text-white mb-6">Welcome to Project Panel</h1>
                <p class="text-center text-gray-400 mb-8">Sign in or create an account to manage your projects.</p>

                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-300">Email address</label>
                        <input id="login-email" type="email" required class="mt-1 block w-full px-4 py-2 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm placeholder-gray-500 focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input id="login-password" type="password" required class="mt-1 block w-full px-4 py-2 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm placeholder-gray-500 focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <button type="submit" id="login-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        Sign In
                    </button>
                    <div id="error-message" class="text-red-400 text-sm text-center"></div>
                </form>

                <div class="mt-6 text-center text-sm text-gray-400">
                    <span id="login-toggle-text">Don't have an account?</span> <a href="#" id="toggle-signup" class="font-medium text-purple-400 hover:text-purple-300">Sign up here</a>
                </div>
            </div>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="hidden flex-grow flex flex-col transition-opacity duration-500">
            <header class="p-6 border-b border-gray-700 flex justify-between items-center bg-gray-900">
                <div class="flex items-center">
                    <i class="fas fa-list-check text-2xl text-purple-500 mr-4"></i>
                    <h2 class="text-xl md:text-2xl font-bold text-white">Your Projects</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-email-display" class="text-sm text-gray-400 hidden md:inline"></span>
                    <button id="logout-btn" class="text-sm font-medium text-gray-400 hover:text-white focus:outline-none">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <button id="add-project-btn" class="bg-purple-600 text-white rounded-full p-3 shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </header>

            <div class="p-6 flex-grow overflow-y-auto project-list-container">
                <!-- Changed the following line to use Tailwind's grid system for better layout control -->
                <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Project cards will be injected here by JavaScript -->
                    <div id="loading-indicator" class="text-center text-gray-400 hidden col-span-full">
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                        <p class="mt-2">Loading projects...</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Project Modal (hidden by default) -->
    <div id="project-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all scale-95 md:scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-white">Add New Project</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-200 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="project-form" class="space-y-4">
                <div>
                    <label for="project-title" class="block text-sm font-medium text-gray-300">Project Title</label>
                    <input id="project-title" type="text" required class="mt-1 block w-full px-4 py-2 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label for="client-name" class="block text-sm font-medium text-gray-300">Client Name</label>
                    <input id="client-name" type="text" required class="mt-1 block w-full px-4 py-2 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label for="project-status" class="block text-sm font-medium text-gray-300">Project Status</label>
                    <select id="project-status" required class="mt-1 block w-full px-4 py-2 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                        <option value="To Do">To Do</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Awaiting Feedback">Awaiting Feedback</option>
                        <option value="Under Review">Under Review</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div>
                    <label for="project-notes" class="block text-sm font-medium text-gray-300">Project Notes</label>
                    <textarea id="project-notes" rows="3" class="mt-1 block w-full px-4 py-2 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm placeholder-gray-500 focus:outline-none focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div>
                    <label for="project-progress" class="block text-sm font-medium text-gray-300">
                        Progress: <span id="progress-value">0</span>%
                    </label>
                    <!-- Change: Added disabled attribute to prevent user interaction -->
                    <input id="project-progress" type="range" min="0" max="100" value="0" class="mt-1 block w-full" disabled>
                </div>
                <button type="submit" id="submit-project-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <span id="submit-text">Add Project</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal (NEW) -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-95 md:scale-100">
            <h3 class="text-xl font-bold text-white mb-4">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to delete this project? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="py-2 px-4 rounded-md text-sm font-medium text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="py-2 px-4 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        /*
         * Firestore Permission Error Fix
         * * The error "Missing or insufficient permissions" means that the Firebase Security Rules are not allowing
         * your application to read or write data to the Firestore database.
         * * To fix this, you must go to the Firebase console for this project, navigate to the "Firestore Database" section,
         * click on the "Rules" tab, and replace the existing rules with the following.
         * These rules ensure that only authenticated users can read and write to their own private data path.
         *
         * Your security rules should look like this:
         *
         * rules_version = '2';
         * service cloud.firestore {
         * match /databases/{database}/documents {
         * // This rule allows authenticated users to read and write to their own data.
         * // It matches the path `artifacts/{appId}/users/{userId}/...`
         * match /artifacts/{appId}/users/{userId}/{documents=**} {
         * allow read, write: if request.auth != null && request.auth.uid == userId;
         * }
         * }
         * }
         *
         * The code below is already configured to use the correct data path. The fix is external to the code.
         */

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, collection, onSnapshot, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        // Your custom firebaseConfig object
        const firebaseConfig = {
            apiKey: "AIzaSyAiePySovptCb9qKDmSZJRpf6_C9O078bQ",
            authDomain: "project-panel-541aa.firebaseapp.com",
            projectId: "project-panel-541aa",
            storageBucket: "project-panel-541aa.firebasestorage.app",
            messagingSenderId: "132678345961",
            appId: "1:132678345961:web:b78ceb9e78f8c0d7557c78",
            measurementId: "G-87Y09B729P"
        };
        const appId = firebaseConfig.projectId; // Set appId to match your project's ID
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let unsubscribeFromProjects = null;

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginHeading = document.getElementById('login-heading');
        const loginToggleText = document.getElementById('login-toggle-text');
        const errorMessage = document.getElementById('error-message');
        const toggleSignupLink = document.getElementById('toggle-signup');
        const userEmailDisplay = document.getElementById('user-email-display');
        const projectListContainer = document.getElementById('project-list');
        const addProjectBtn = document.getElementById('add-project-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const projectModal = document.getElementById('project-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const projectForm = document.getElementById('project-form');
        const projectTitleInput = document.getElementById('project-title');
        const clientNameInput = document.getElementById('client-name');
        const projectStatusSelect = document.getElementById('project-status');
        const projectNotesInput = document.getElementById('project-notes');
        const projectProgressInput = document.getElementById('project-progress');
        const progressValueDisplay = document.getElementById('progress-value');
        const modalTitle = document.getElementById('modal-title');
        const submitBtn = document.getElementById('submit-project-btn');
        const submitText = document.getElementById('submit-text'); // Renamed submitText to refer to the span element
        const loadingIndicator = document.getElementById('loading-indicator');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // State variables
        let isSigningUp = false;
        let isEditMode = false;
        let currentProjectId = null;
        let projectIdToDelete = null;

        // --- Helper Functions ---
        const showPage = (pageId) => {
            loginPage.classList.add('hidden');
            dashboard.classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        };

        const showModal = (title, submitBtnLabel) => {
            modalTitle.textContent = title;
            submitText.textContent = submitBtnLabel; // Corrected usage of submitText
            projectModal.classList.remove('hidden');
        };

        const hideModal = () => {
            projectModal.classList.add('hidden');
            projectForm.reset();
            isEditMode = false;
            currentProjectId = null;
            // Reset progress value display
            progressValueDisplay.textContent = 0;
            projectProgressInput.value = 0;
        };

        const showDeleteModal = () => {
            deleteModal.classList.remove('hidden');
        };

        const hideDeleteModal = () => {
            deleteModal.classList.add('hidden');
            projectIdToDelete = null;
        };
        
        const showLoading = (show) => {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        };

        const createProjectCard = (project) => {
            const card = document.createElement('div');
            // Replaced the flex classes with grid-column classes for consistent sizing.
            card.classList.add('bg-gray-700', 'p-6', 'rounded-xl', 'shadow-md', 'border', 'border-gray-600');
            card.dataset.id = project.id;
            
            const statusColor = {
                'To Do': 'bg-red-500 text-white',
                'In Progress': 'bg-yellow-500 text-white',
                'Awaiting Feedback': 'bg-blue-500 text-white',
                'Under Review': 'bg-orange-500 text-white',
                'On Hold': 'bg-gray-500 text-white',
                'Completed': 'bg-green-500 text-white'
            };

            // Logic to determine progress bar color based on status
            const progressBarColor = {
                'To Do': 'bg-red-500',
                'In Progress': 'bg-blue-500',
                'Awaiting Feedback': 'bg-yellow-500',
                'Under Review': 'bg-orange-500',
                'On Hold': 'bg-red-700', // A more distinct red for On Hold
                'Completed': 'bg-green-500'
            };

            const statusClass = statusColor[project.status] || 'bg-gray-500 text-white';
            const progressColorClass = progressBarColor[project.status] || 'bg-purple-600'; // Default to purple if status is unknown

            const progress = project.progress !== undefined ? project.progress : 0;
            const notes = project.notes || 'No notes.';

            // Get last updated date, default to creation date if not available
            const lastUpdated = project.updatedAt ? project.updatedAt.toDate() : project.createdAt.toDate();
            const formattedDate = lastUpdated.toLocaleDateString() + ' ' + lastUpdated.toLocaleTimeString();

            card.innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="flex-grow">
                        <h4 class="text-lg font-semibold text-gray-100 mb-1">${project.title}</h4>
                        <p class="text-sm text-gray-400 mb-2"><i class="fas fa-user-tie text-gray-500 mr-2"></i>Client: ${project.clientName}</p>
                        <p class="text-sm text-gray-400 mb-4"><i class="fas fa-sticky-note text-gray-500 mr-2"></i>Notes: ${notes}</p>
                        <div class="flex items-center space-x-4 mb-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                <i class="fas fa-circle text-xs mr-2"></i>${project.status}
                            </span>
                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-600 rounded-full h-2.5">
                                <div class="${progressColorClass} h-2.5 rounded-full" style="width: ${progress}%;"></div>
                            </div>
                            <span class="text-sm text-gray-400">${progress}%</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Last Updated: ${formattedDate}</p>
                    <div class="flex items-center space-x-2 mt-4 self-end">
                        <button class="edit-btn bg-purple-500 text-white p-2 rounded-full hover:bg-purple-600 transition-colors duration-200" title="Edit">
                            <i class="fas fa-edit text-sm"></i>
                        </button>
                        <button class="delete-btn bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition-colors duration-200" title="Delete">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                </div>
            `;
            
            card.querySelector('.edit-btn').addEventListener('click', () => editProject(project));
            card.querySelector('.delete-btn').addEventListener('click', () => {
                projectIdToDelete = project.id;
                showDeleteModal();
            });
            
            return card;
        };

        const renderProjects = (projects) => {
            projectListContainer.innerHTML = '';
            if (projects.length === 0) {
                projectListContainer.innerHTML = '<p class="text-center text-gray-400">No projects found. Add your first project!</p>';
            } else {
                projects.forEach(project => {
                    projectListContainer.appendChild(createProjectCard(project));
                });
            }
        };

        // --- Firebase Firestore Functions ---
        const getProjects = async (currentUserId) => {
            if (unsubscribeFromProjects) {
                unsubscribeFromProjects(); // Unsubscribe from previous listener
            }

            // Using the private data path for each user
            const projectsColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/projects`);
            const q = query(projectsColRef);

            showLoading(true);

            unsubscribeFromProjects = onSnapshot(q, (snapshot) => {
                showLoading(false);
                const projects = [];
                snapshot.forEach(doc => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                renderProjects(projects);
            }, (error) => {
                showLoading(false);
                console.error("Error fetching projects:", error);
                // Providing a specific message for the permission error.
                console.error("This is likely a Firestore Security Rules issue. Please check your Firebase console and ensure rules allow read/write access to your user's data.");
            });
        };

        const addOrUpdateProject = async (projectData) => {
            if (!userId) {
                console.error("No authenticated user to save project.");
                return;
            }
            try {
                const projectsColRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
                if (isEditMode && currentProjectId) {
                    // Update existing project
                    const projectDocRef = doc(projectsColRef, currentProjectId);
                    await updateDoc(projectDocRef, { ...projectData, updatedAt: Timestamp.now() }); // Update updatedAt
                } else {
                    // Add new project
                    await addDoc(projectsColRef, {
                        ...projectData,
                        userId: userId,
                        createdAt: Timestamp.now(),
                        updatedAt: Timestamp.now() // Add updatedAt on creation
                    });
                }
                hideModal();
            } catch (error) {
                console.error("Error saving project:", error);
            }
        };

        const deleteProject = async (projectId) => {
            if (!userId) {
                console.error("No authenticated user to delete project.");
                return;
            }
            try {
                const projectDocRef = doc(db, `artifacts/${appId}/users/${userId}/projects`, projectId);
                await deleteDoc(projectDocRef);
                console.log("Project deleted successfully.");
            } catch (error) {
                console.error("Error deleting project:", error);
            }
        };

        const editProject = (project) => {
            isEditMode = true;
            currentProjectId = project.id;
            
            projectTitleInput.value = project.title;
            clientNameInput.value = project.clientName;
            projectStatusSelect.value = project.status;
            projectNotesInput.value = project.notes || '';
            
            // Set progress and update display when editing a project
            const initialProgress = project.progress || 0;
            projectProgressInput.value = initialProgress;
            progressValueDisplay.textContent = initialProgress;

            showModal('Edit Project', 'Update Project');
        };

        // --- Event Listeners ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            errorMessage.textContent = '';
            
            try {
                if (isSigningUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    errorMessage.textContent = 'Account created successfully! You are now logged in.';
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let displayMessage = 'An error occurred. Please try again.';
                if (error.code === 'auth/invalid-email') {
                    displayMessage = 'Please enter a valid email address.';
                } else if (error.code === 'auth/weak-password') {
                    displayMessage = 'Password should be at least 6 characters.';
                } else if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    displayMessage = 'Invalid email or password.';
                } else if (error.code === 'auth/email-already-in-use') {
                    displayMessage = 'This email is already in use. Please sign in or use a different email.';
                }
                errorMessage.textContent = displayMessage;
                console.error("Authentication error:", error);
            }
        });

        // Event listener to toggle between login and sign up forms
        toggleSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            isSigningUp = !isSigningUp;
            errorMessage.textContent = ''; // Clear any previous error messages

            if (isSigningUp) {
                loginBtn.textContent = 'Sign Up';
                loginHeading.textContent = 'Create a New Account';
                loginToggleText.textContent = 'Already have an account?';
                toggleSignupLink.textContent = 'Sign in here';
            } else {
                loginBtn.textContent = 'Sign In';
                loginHeading.textContent = 'Welcome to Project Panel';
                loginToggleText.textContent = 'Don\'t have an account?';
                toggleSignupLink.textContent = 'Sign up here';
            }
        });


        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        });

        addProjectBtn.addEventListener('click', () => {
            projectForm.reset();
            hideModal(); // Ensure modal is reset before showing
            showModal('Add New Project', 'Add Project');
        });

        closeModalBtn.addEventListener('click', hideModal);
        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        confirmDeleteBtn.addEventListener('click', async () => {
            await deleteProject(projectIdToDelete);
            hideDeleteModal();
        });

        // Map status to a default progress value
        const statusProgressMap = {
            'To Do': 0,
            'In Progress': 25,
            'Awaiting Feedback': 60,
            'Under Review': 85,
            'On Hold': 10,
            'Completed': 100
        };

        // Listen for changes in the project status dropdown
        projectStatusSelect.addEventListener('change', (e) => {
            const newStatus = e.target.value;
            const newProgress = statusProgressMap[newStatus] || 0;
            
            projectProgressInput.value = newProgress;
            progressValueDisplay.textContent = newProgress;
        });

        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectData = {
                title: projectTitleInput.value,
                clientName: clientNameInput.value,
                status: projectStatusSelect.value,
                notes: projectNotesInput.value,
                progress: parseInt(projectProgressInput.value, 10),
            };
            await addOrUpdateProject(projectData);
        });

        // --- Firebase Authentication State Change Listener ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                userId = user.uid;
                userEmailDisplay.textContent = user.email;
                showPage('dashboard');
                getProjects(userId);
            } else {
                // User is signed out
                userId = null;
                userEmailDisplay.textContent = '';
                showPage('login-page');
            }
        });

        // --- Initial Authentication ---
        // This part has been changed to only handle the authentication state change listener
        // and not attempt an initial anonymous sign-in, which was causing the error.
        // The onAuthStateChanged listener will handle the initial state and show the login page
        // if no user is signed in.
    </script>
</body>
</html>
